<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>财务列表</title>
    <!--地址选择器-->
    <link rel="stylesheet" href="../css/dependencies.min.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/pageTopBar.css">
    <link rel="stylesheet" href="../css/upload.min.css">
    <link rel="stylesheet" href="../css/goodsManage.css">
    <link rel="stylesheet" href="../css/auctionOrder.css">
    <link rel="stylesheet" href="../css/selectmenu.css">
    <link rel="stylesheet" href="../css/auctionsGoodsRelease.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1449947_cwofdqsmxjf.css">
    <style>
        .control-label{
            text-align: right;
        }
        .address_info_top .top-item{
            display: inline-block;
            font-size: 13px;
        }
        .address_info_top .phone{
            color: #f60;
        }
        .address_info_top .receiver{
            color: #000;
        }
        .address{
            font-size: 12px;
            color: #777;
        }
    </style>
</head>
<body class="hide-help">
<script src="../js/dependencies.min.js"></script>
<script src="../js/pettyb.min.js"></script>
<script src="../config/api.config.js"></script>
<script src="../js/upload.min.js"></script>
<script src="../js/selectmenu.js"></script>
<div class="sections">
    <!--地址选择器-->
    <div class="col-sm-12" style="display: flex;align-items: center;justify-content: space-between;">
        <!--搜索条件-->
        <form class="zent-form zent-form--horizontal filter-container">
            <div class="filter-fields-wrap">
                <div class="filter-item">
                    <div class="filter-item__field">
                        <div class="form__control-group order-label">
                            <label class="form__control-label">用户搜索：</label>
                            <div class="form__controls">
                                <div class="select-wrapper select--size-normal">
                                    <div class="select-text" data-value="username" id="goods-search-type">用户名称</div>
                                </div>
                            </div>
                        </div>
                        <div class="form__control-group search-value">
                            <label class="form__control-label"></label>
                            <div class="form__controls">
                                <div class="input-wrapper input--size-normal">
                                    <input name="keyword" type="text" class="input-common" id="goods-search-value">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="buttonn-primary btn-common" id="filter-search-btn">筛选</button>
                <a href="javascript:;" class="reset-form margin-left-8" id="AllModal">清空筛选条件</a>
            </div>
        </form>
    </div>
    <div class="orderState">
        <div>
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="order-tap active" data-status="all"><a href="#" aria-controls="home" role="tab" data-toggle="tab">全部</a></li>
                <li role="presentation" class="order-tap" data-status="0"><a href="#" aria-controls="profile" role="tab" data-toggle="tab">待处理</a></li>
                <li role="presentation" class="order-tap" data-status="1"><a href="#" aria-controls="messages" role="tab" data-toggle="tab">已处理</a></li>
            </ul>
        </div>
    </div>
    <div class="col-sm-12">
        <table id="contentTable" data-mobile-responsive="true" data-click-to-select="true" data-thead-classes="thead-light">
            <thead>
            <tr>
                <th data-field="code" data-checkbox="true"></th>
                <th data-halign="center" data-align="center" data-width="50" data-field="id">ID</th>
                <th data-field="avatar"  data-width="60" data-formatter="GoodsFormat">用户头像</th>
                <th data-valign="middle" data-field="username">用户名称</th>
                <th data-valign="middle" data-field="amount">提现金额</th>
                <th data-valign="middle" data-field="created_at">提现时间</th>
                <th data-valign="middle" data-field="updated_at">处理时间</th>
                <th data-valign="middle" data-field="reason">处理原因</th>
                <th data-valign="middle" data-field="status" data-width="100" >提现状态</th>
                <th data-valign="middle" data-align="center" data-width="200" data-field="operation" data-formatter="OperationFormat">操作</th>
            </tr>
            </thead>
        </table>
    </div>
</div>
<!--处理modal-->
<div class="modal fade bs-example-modal-lg" id="editGoodsModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="myLargeModalLabel">处理提现申请</h4>
            </div>
            <div class="modal-body">
                <div class="sections">
                    <!--价格信息-->
                    <div class="goodsClassify">
                        <div class="goodsContent">
                            <div class="messageItem">
                                <div class="control"><i class="xing">*</i>拒绝理由：</div>
                                <div class="formControls smallInput"><input type="text" class="ReasonsRefusal"></div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="preserved">
                    <button type="button" id="edit-submit-btn" class="zent-btn-primary zent-btn">拒绝</button>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>
</div>
<div class="modal fade bs-example-modal-lg" id="agreeGoodsModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">处理提现申请</h4>
            </div>
            <div class="modal-body">
                <div class="sections">
                    <!--价格信息-->
                    <div class="goodsClassify">
                        <div class="goodsContent">
                            <div class="messageItem">
                                <div class="control"><i class="xing">*</i>同意理由：</div>
                                <div class="formControls smallInput"><input type="text" class="agreeReasonsRefusal"></div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="preserved">
                    <button type="button" id="financeAgree" class="zent-btn-primary zent-btn">同意</button>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>
</div>
<script>
    /**
     * @return {string}
     */
    function GoodsFormat(value, row, index) {
        var serverId = value;
        var default_image = domainConfig.baseUrl + domainConfig.AppNameAlias + '/img/image-default.jpg';
        if (row.avatar == null) {
            return '<div class="goods-container">' +
                '<div class="goods-image">' +
                '<img style="width:60px;" class="goodsImage" data-state="0"  src="'+default_image+'"/>' +
                '</div>' +
                '</div>';
        } else {
            return '<div class="goods-container">' +
                '<div class="goods-image">' +
                '<img style="width:60px;" class="goodsImage" data-state="0"  src="' + row.avatar + '"/>' +
                '</div>' +
                '</div>';
        }
    }

    //操作
    /**
     * @return {string}
     */
    function OperationFormat(value,row,index){
        if(row.status_value == '0'){
            return '<div class="table-options">' +
                '<a href="javascript:;" class="look-btn option-item financeAgree" data-id="'+row.id+'">同意</a>' +
                '<span class="split">|</span>' +
                '<a href="javascript:;" class="edit-address-btn option-item financeRefuse" data-id="'+row.id+'">拒绝</a>' +
                '</div>';
        }else{
            return '<div class="table-options">' +'已处理'+
                '</div>';
        }
    }
    $(function(){
        var isGoToFirstPage = false;
        var isFilter = false;//是否在筛选的条件下
        var back_page = 1;//需要还原的页码数
        var order_status = 'all';//订单状态
        //渲染表格
        $('#contentTable').bootstrapTable({
            method: 'post',
            contentType: "application/x-www-form-urlencoded",//必须要有！！！！
            url: api.financeList,//要请求数据的文件路径
            sidePagination: "server", //服务端处理分页
            queryParams: function (params) {//自定义参数，这里的参数是传给后台的，我这是是分页用的
                var page_size = params.limit;
                var offset = params.offset;
                var page = offset / page_size + 1;
                if(!isFilter){
                    //如果不是在筛选的条件下，需要记录一下返回的页面
                    back_page = page;
                }
                if (isGoToFirstPage){
                    isGoToFirstPage = false;
                    return {//这里的params是table提供的
                        page: 1//从数据库第几条记录开始
                        , page_size: params.limit  //找多少条
                        ,condition: $("#goods-search-type").attr("data-value")
                        ,keyword: $("#goods-search-value").val()
                        ,status:order_status
                    };
                }else {
                    return {//这里的params是table提供的
                        page: page//从数据库第几条记录开始
                        , page_size: params.limit  //找多少条
                        ,condition: $("#goods-search-type").attr("data-value")
                        ,keyword:$("#goods-search-value").val()
                        ,status:order_status
                    };
                }

            },
            ajaxOptions: {
                headers: {
                    'appid': Config.AppAppid,
                    'mbcore-access-token': localStorage.getItem(Config.VLSAccessToken),
                    'mbcore-auth-token': localStorage.getItem(Config.VLSAuthToken)
                }
            },
            search: false,  //是否启用搜索框
            //searchText:'',  //初始化搜索文字
            showColumns: false, //是否显示内容列下拉框
            pagination: true,  //设置为 true 会在表格底部显示分页条。
            showRefresh: false,  //是否显示刷新按钮
            showFullscreen: false, //是否显示全屏按钮
            //showToggle: true,  //是否显示切换视图（table/card）按钮。
            iconSize: 'outline',
//            toolbar: '#contentTableToolbar',
            clickToSelect: true,//是否启用点击选中行
            striped: true, //是否显示行间隔色
            dataField: "data",//bootstrap table 可以前端分页也可以后端分页，这里
            //我们使用的是后端分页，后端分页时需返回含有total：总记录数,这个键值好像是固定的
            //rows： 记录集合 键值可以修改  dataField 自己定义成自己想要的就好
            pageNumber: 1, //初始化加载第一页，默认第一页
            pageSize:20,//单页记录数
            pageList:[5,10,20,30],//分页步进值
            responseHandler: function (res) {
                //在ajax获取到数据，渲染表格之前，修改数据源
                console.log(res);
                if (res.code) {
                    return res.result;
                } else {
                    layer.msg(res.result.msg);
                    return {
                        data:[],
                        total:0
                    };
                }

            },
            onLoadSuccess:function () {
                console.log("onLoadSuccess");
                //console.log($('img[data-value="6e920678-3c39-4609-ab0a-fc6888655056"]').length);
                disposeImageUrl();
            },
            onResetView:function () {
                console.log("onResetView");
                //console.log($('img[data-value="6e920678-3c39-4609-ab0a-fc6888655056"]').length);
                disposeImageUrl();
            }
        });
        // //同意
        // $(document).on("click",".financeAgree",function () {
        //     var id = $(this).data("id");
        //     layer.confirm('确定同意用户提现申请', {
        //         btn: ['取消','确定'], //按钮
        //         shade: false //不显示遮罩
        //     }, function(inds){
        //         //点击取消
        //         layer.close(inds);
        //     }, function(inds){
        //         //点击确定
        //         layer.close(inds);
        //         $.Ajax({
        //             url:api.financeAgree,
        //             data:{
        //               id:id
        //             },
        //             is_login:true,
        //             success:function (res) {
        //                 if (res.code == 1){
        //                     layer.msg("提现成功");
        //                     $('#contentTable').bootstrapTable('refresh');
        //                 }else {
        //                     layer.msg(res.result.msg)
        //                 }
        //
        //             }
        //         })
        //     })
        // });
        //同意
        $(document).on("click",".financeAgree",function () {
            var id = $(this).data("id");
            $("#agreeGoodsModal").modal("show");
            $('#financeAgree').attr('data-id',id);
        });
        //同意理由
        $(document).on("click","#financeAgree",function () {
            var id =  $(this).attr("data-id"); //用户id
            var refuse_reason = $(".agreeReasonsRefusal").val();
            $.Ajax({
                url:api.financeAgree,
                data:{
                    id:id,
                    reason:refuse_reason
                },
                is_login:true,
                success:function (res) {
                    if (res.code == 1){
                        $("#agreeGoodsModal").modal("hide");
                        layer.msg("提现成功");
                        $('#contentTable').bootstrapTable('refresh');
                    }else {
                        layer.msg(res.result.msg)
                    }

                }
            })
        });
        //拒绝
        $(document).on("click",".financeRefuse",function () {
            var id = $(this).data("id");
            $("#editGoodsModal").modal("show");
            $('#edit-submit-btn').attr('data-id',id);
        });
        //拒绝理由
        $(document).on("click","#edit-submit-btn",function () {
            var id =  $(this).attr("data-id"); //用户id
            var refuse_reason = $(".ReasonsRefusal").val();
            $.Ajax({
                url:api.financeRefuse,
                data:{
                    id:id,
                    reason:refuse_reason
                },
                is_login:true,
                success:function (res) {
                    if (res.code == 1){
                        $("#editGoodsModal").modal("hide");
                        layer.msg("拒绝成功");
                        $('#contentTable').bootstrapTable('refresh');
                    }else {
                        layer.msg(res.result.msg)
                    }

                }
            })
        });

        var goodsSearchTypeData = [
            {id: 'username', name: '用户昵称'},
        ];
        //select列表实例
        $(document).on("click", "#goods-search-type", function () {
            var $this = $(this);
            $this.selectMenu({
                title: false,
                showField: 'name',
                keyField: 'id',
//                orderBy : ['id desc','name'],
                initSelected: 'username',
                search: false,//关闭搜索栏
                data: goodsSearchTypeData,
                eSelect: function (data) {
                    if (data[0]) {
                        $this.html(data[0].name);
                        $this.attr("data-value", data[0].id);
                        $this.removeClass("visible");
                    }
                }
            });
        });
        //点击订单分类
        $(".order-tap").click(function () {
            order_status = $(this).attr("data-status");
            isGoToFirstPage = true;
            console.log(order_status);
            $('#contentTable').bootstrapTable('refresh',{
                pageNumber: 1
            });
            if(order_status == 1){
                $(function () {
                    // LoadingDataListOrderRealItems();
                    $('#contentTable').bootstrapTable('hideColumn', 'operation');
                });
            }else{
                // $(function () {
                //     // LoadingDataListOrderRealItems();
                    $('#contentTable').bootstrapTable('showColumn', 'operation');
                // });
            }
        });

        //右边条件搜索
        $(document).on("click","#filter-search-btn",function () {
            isGoToFirstPage = true;
            isFilter = true;//正在搜索
            $('#contentTable').bootstrapTable('refresh',{
                pageNumber: 1
            });
        });
        // 点击清空筛选条件
        $(document).on("click","#AllModal",function () {
            if (back_page == 1){
                isGoToFirstPage = true;
            }else {
                isGoToFirstPage = false;
            }
            $("#goods-search-value").val("");
            $("#goods-search-type").attr("data-value", "username");
            $("#goods-search-type").html("用户名称");
            $('#goods-search-type').selectMenuClear();
            $('#contentTable').bootstrapTable('refresh',{
                pageNumber:back_page
            });
            isFilter = false;//不在筛选的状态下
        });

        function disposeImageUrl() {
            var serverIds = [];
            $('img.goodsImage[data-state="0"]').map(function (index,item) {
                //console.log($(item));
                serverIds.push($(item).data('value'));
            });
            if(serverIds.length==0){
                console.log('无数据');
                return true;
            }
            //console.log(serverIds);
            getImageUrl(serverIds,function (res) {
                for(var serverId in res){
                    $('img[data-value="'+serverId+'"]').attr('src',res[serverId].url).data('state',1);
                }
            })
        }
    })
</script>
</body>
</html>